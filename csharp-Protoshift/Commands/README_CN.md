# 命令行相关功能说明

## 命令行参数传递原则（开发人员）

程序使用类 Microsoft C/C++ 代码使用的命令行分析规则（为了方便解释，我们同样将返回值称为 `argv`）。下面是一组 `CommandHandlerBase.ParseAsArgs`_（`ICommandHandler.cs:`）_ 命令行参数分析结果的例子：

| 命令行输入 | argv[0] | argv[1] | argv[2] |
| :----------- | :----------- | :----------- | :----------- |
| `"abc" d e` | `abc` | `d` | `e` |
| `a\\b d"e f"g h` | `a\b` | `de fg` | `h` |
| `a\\\"b c d` | `a\"b` | `c` | `d` |
| `a\\\\"b c" d e` | `a\\b c` | `d` | `e` |
| `a"b"" c d` | `ab c d` |  |  |
| `a"b"\" c d` | `ab"` | `c` | `d` |
| `ab\n cd` | `abn` | `cd` |  |

具体规则如下：

- 参数用空白分隔，空白可以是一个空格或制表符。

- 与应用至系统的算法不同，并不对 `argv[0]` 作特殊处理，因为其与 `CommandLine` 的 dispatcher 天然不兼容。

- 将双引号括起来的字符串解释为单个参数，哪怕其中可能包含空格 character。带引号的字符串可以嵌入在自变量内。未将插入点 (`^`) 识别为转义 character 或者分隔符。在带引号的字符串中，一对双引号被解释为单个转义的双引号。如果命令行结束时未发现后双引号，则到目前为止读取的所有 character 将输出为最后一个参数。  
  未成对的引号会被直接忽略，并将后续读取的所有 character 视为为最后一个参数；不同的是该引号会被忽略，如样例 5（标准算法应输出 `ab" c d`）。如果期望其正常工作应为 `"` 添加反斜杠转义，例如样例 6.

- 前面有反斜杠的双引号 (`\"`) 被解释为原义双引号 (`"`)。

- 这里与标准算法不同：不接受除 `\\` 或 `\"` 外的所有转义，但是单独的反斜杠仍会被忽略，例如样例 7.

- 如果偶数个反斜杠后跟双引号，则每对反斜杠 (`\\`) 中有一个反斜杠 (`\`) 被置于 `argv` 数组中，而双引号 (`"`) 被解释为字符串分隔符。

- 如果奇数个反斜杠后跟双引号，则每对反斜杠 (`\\`) 中有一个反斜杠 (`\`) 被置于 `argv` 数组中。将双引号解释为包含 remaining 反斜杠的转义序列，导致将原义双引号 (`"`) 置于 `argv` 中。

（注：上面与 Microsoft C/C++ 代码使用的命令行分析标准算法的差异均视为 bug。暂时视为 feature，因为作者暂时并无精力修复这些问题。如有意向解决，请参考 [分析 C++ 命令行自变量 - `main` 函数和命令行参数 | Microsoft Learn](https://learn.microsoft.com/zh-cn/cpp/cpp/main-function-command-line-args#parsing-c-command-line-arguments)）

## 附录 1：`CommandHandlerBase.ParseAsArgs` 编写原则

该方法通过 ChatGPT 生成。prompt 如下：

```md
请编写一个 C# 方法 `string[] ParseAsArgs(string cmd)`，输入一段字符串，模拟控制台的形式将其转换为控制台参数数组 `string[] argv`。以顶级语句格式编写，即代码仅包含开头的 using 与顶级方法声明与主体。

注意：不可省略任何代码逻辑。不可以使用命令行相关的 nuget 程序包（因为它们的行为方式可能与上述规则不同）。

你编写的代码需要遵循如下 Microsoft C/C++ 代码使用的命令行分析规则（为了方便解释，我们同样将返回值称为 `argv`）：

- 参数用空白分隔，空白可以是一个空格或制表符。

- 第一个参数 (`argv[0]`) 是经过专门处理的。它表示程序名称。因为它必须是有效的路径名，因此允许用双引号 (`"`) 括起来一些部分。双引号不包含在 `argv[0]` 输出中。用双引号括起来的部分可以防止将空格或 tab character 解释为参数的末尾。 此列表中的后续规则不适用。_（提问者注：在实际代码编写中，请你忽略 `argv[0]` 的特殊处理逻辑（也就是假定第一个参数并不表示程序名称），并使用此列表的后续规则。样例表也遵循此原则。）_

- 将双引号括起来的字符串解释为单个参数，哪怕其中可能包含空格 character。 带引号的字符串可以嵌入在自变量内。 未将插入点 (`^`) 识别为转义 character 或者分隔符。 在带引号的字符串中，一对双引号被解释为单个转义的双引号。 如果命令行结束时未发现后双引号，则到目前为止读取的所有 character 将输出为最后一个参数。

- 前面有反斜杠的双引号 (`\"`) 被解释为原义双引号 (`"`)。

- 反斜杠按其原义解释，除非它们紧位于双引号之前。

- 如果偶数个反斜杠后跟双引号，则每对反斜杠 (`\\`) 中有一个反斜杠 (`\`) 被置于 `argv` 数组中，而双引号 (`"`) 被解释为字符串分隔符。

- 如果奇数个反斜杠后跟双引号，则每对反斜杠 (`\\`) 中有一个反斜杠 (`\`) 被置于 `argv` 数组中。 将双引号解释为包含 remaining 反斜杠的转义序列，导致将原义双引号 (`"`) 置于 `argv` 中。

下示样例表显示了示例输入和预期输出，演示了前面列表中的规则。

| 命令行输入 | argv[1] | argv[2] | argv[3] |
| :----------- | :----------- | :----------- | :----------- |
| `"abc" d e` | `abc` | `d` | `e` |
| `a\\b d"e f"g h` | `a\\b` | `de fg` | `h` |
| `a\\\"b c d` | `a\"b` | `c` | `d` |
| `a\\\\"b c" d e` | `a\\b c` | `d` | `e` |
| `a"b"" c d` | `ab" c d` |  |  |
```

注：代码通过了文档所示样例第 1、3、4 组。对于第 5 组，尝试令 ChatGPT 修复无果。下为 prompt：

```md
你的代码未通过样例第五组数据 `a"b"" c d`，期望输出 `ab" c d`，实际输出 `ab c d`。请你排查并调整代码，尝试修复问题。

提示：你的代码在不存在转义符号时会直接跳过 `"`，只将其当作设置 inQuotes 变量的工具。在字符串包含偶数个引号时这可以成立，但是在第五组数据中包含一个未配对的引号，此时引号数为奇数，因此它本应该被输出到最后一个参数中但实际被忽略了。修复这个问题可能需要对源代码实施较大的修改。
```
